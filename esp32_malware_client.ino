

#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <WiFiClientSecure.h>

// Struct definitions must come before use
struct NetworkData {
  int id_orig_p;
  int id_resp_p;
  float duration;
  int orig_bytes;
  int resp_bytes;
  int missed_bytes;
  int orig_pkts;
  int orig_ip_bytes;
  int resp_pkts;
  int resp_ip_bytes;
};

struct ThreatAnalysis {
  bool is_malicious;
  float confidence;
  String threat_level;
  String recommendation;
  String error;
};

const char* ssid = "BSNL_4G";
const char* password = "gurdevil@";

const char* api_server = "http://192.168.1.33:8080";
const char* api_endpoint = "/predict/simple";
const int api_timeout = 10000;

// LED Pins for D2, D4, D5
const int LED_SAFE = 2;      // D2 - Green LED (safe traffic)
const int LED_THREAT = 4;    // D4 - Red LED (threat detected)
const int LED_STATUS = 5;    // D5 - Blue/Yellow LED (status)

unsigned long lastCheck = 0;
const unsigned long checkInterval = 30000;
int connectionCount = 0;
bool systemActive = true;

void setup() {
  Serial.begin(115200);
  delay(1000);  // Give serial time to initialize
  
  pinMode(LED_SAFE, OUTPUT);
  pinMode(LED_THREAT, OUTPUT);
  pinMode(LED_STATUS, OUTPUT);
  
  startupSequence();
  
  Serial.println("\n\n");
  Serial.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘  ESP32 IoT Malware Detection Client   â•‘");
  Serial.println("â•‘      3-LED Indicator System Active     â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println();
  
  connectToWiFi();
  
  testAPIConnection();
  
  Serial.println("\nâœ… System ready for malware detection");
  Serial.println("ğŸ’¡ LED Indicators:");
  Serial.println("   â€¢ Green (D2) = Safe traffic");
  Serial.println("   â€¢ Red (D4) = Threat detected");
  Serial.println("   â€¢ Blue (D5) = Status/Activity");
  Serial.println();
  digitalWrite(LED_STATUS, HIGH);
  delay(500);
  digitalWrite(LED_STATUS, LOW);
}

void loop() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("\nâš ï¸  WiFi disconnected, reconnecting...");
    digitalWrite(LED_STATUS, LOW);
    connectToWiFi();
    return;
  }
  
  if (millis() - lastCheck >= checkInterval) {
    Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.println("ğŸ• Check #" + String(connectionCount + 1) + " - " + String(millis()/1000) + "s uptime");
    performSecurityCheck();
    lastCheck = millis();
  }
  
  monitorNetworkActivity();
  
  delay(1000);
}

void connectToWiFi() {
  Serial.println("ğŸŒ Connecting to WiFi: " + String(ssid));
  Serial.print("   ");
  
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
    
    digitalWrite(LED_STATUS, !digitalRead(LED_STATUS));
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println(" Connected!");
    Serial.println("âœ… WiFi connected successfully!");
    Serial.println("ğŸ“¡ ESP32 IP Address: " + WiFi.localIP().toString());
    Serial.println("ğŸ–¥ï¸  Server IP: " + String(api_server));
    digitalWrite(LED_STATUS, HIGH);
    delay(200);
    digitalWrite(LED_STATUS, LOW);
  } else {
    Serial.println(" Failed!");
    Serial.println("âŒ WiFi connection failed after " + String(attempts) + " attempts");
    digitalWrite(LED_STATUS, LOW);
  }
}

void testAPIConnection() {
  Serial.println("\nğŸ” Testing API connection...");
  Serial.println("   Target: " + String(api_server) + "/health");
  
  HTTPClient http;
  http.begin(String(api_server) + "/health");
  http.setTimeout(api_timeout);
  
  int httpCode = http.GET();
  
  if (httpCode == 200) {
    String response = http.getString();
    Serial.println("âœ… API server is ONLINE and responding");
    Serial.println("ğŸ“Š Response: " + response);
    
    // Success blink - status LED
    for(int i=0; i<3; i++) {
      digitalWrite(LED_STATUS, HIGH);
      delay(100);
      digitalWrite(LED_STATUS, LOW);
      delay(100);
    }
  } else {
    Serial.println("âŒ API server connection FAILED");
    Serial.println("ğŸ”§ HTTP Code: " + String(httpCode));
    Serial.println("ğŸ’¡ Make sure server is running: ./start_local_server.sh");
    
    // Error blink - status LED
    for(int i=0; i<5; i++) {
      digitalWrite(LED_STATUS, HIGH);
      delay(50);
      digitalWrite(LED_STATUS, LOW);
      delay(50);
    }
  }
  
  http.end();
}

void performSecurityCheck() {
  Serial.println("ğŸ” Performing security check...");
  
  // Status LED on during check
  digitalWrite(LED_STATUS, HIGH);
  
  NetworkData traffic = generateNetworkData();
  
  ThreatAnalysis result = analyzeTraffic(traffic);
  
  handleThreatResult(result);
  
  connectionCount++;
  
  // Status LED off after check
  digitalWrite(LED_STATUS, LOW);
}

NetworkData generateNetworkData() {
  NetworkData data;
  
  int trafficType = random(0, 4);
  
  Serial.println("\nğŸ“¦ Generating Network Traffic Data:");
  
  switch (trafficType) {
    case 0:
      data.id_orig_p = 443;
      data.id_resp_p = 80;
      data.duration = 0.5;
      data.orig_bytes = 1500;
      data.resp_bytes = 8000;
      data.orig_pkts = 10;
      data.resp_pkts = 15;
      data.orig_ip_bytes = 1500;
      data.resp_ip_bytes = 8000;
      Serial.println("   Type: âœ… Normal HTTPS web traffic");
      Serial.println("   Ports: 443 â†’ 80");
      break;
      
    case 1:
      data.id_orig_p = 17576;
      data.id_resp_p = 8081;
      data.duration = 0.000002;
      data.orig_bytes = 0;
      data.resp_bytes = 0;
      data.orig_pkts = 2;
      data.resp_pkts = 0;
      data.orig_ip_bytes = 80;
      data.resp_ip_bytes = 0;
      Serial.println("   Type: ğŸš¨ Suspicious port scan");
      Serial.println("   Ports: 17576 â†’ 8081 (unusual)");
      break;
      
    case 2:
      data.id_orig_p = random(1024, 65535);
      data.id_resp_p = 80;
      data.duration = 0.001;
      data.orig_bytes = 50;
      data.resp_bytes = 0;
      data.orig_pkts = 1;
      data.resp_pkts = 0;
      data.orig_ip_bytes = 50;
      data.resp_ip_bytes = 0;
      Serial.println("   Type: âš¡ Potential DDoS attack pattern");
      Serial.println("   Ports: " + String(data.id_orig_p) + " â†’ 80 (rapid)");
      break;
      
    case 3:
      data.id_orig_p = random(1024, 5000);
      data.id_resp_p = random(80, 443);
      data.duration = random(1, 100) / 100.0;
      data.orig_bytes = random(100, 1000);
      data.resp_bytes = random(50, 500);
      data.orig_pkts = random(1, 10);
      data.resp_pkts = random(1, 8);
      data.orig_ip_bytes = data.orig_bytes;
      data.resp_ip_bytes = data.resp_bytes;
      Serial.println("   Type: ğŸ  IoT device communication");
      Serial.println("   Ports: " + String(data.id_orig_p) + " â†’ " + String(data.id_resp_p));
      break;
  }
  
  data.missed_bytes = 0;
  
  Serial.println("   Duration: " + String(data.duration, 6) + "s");
  Serial.println("   Bytes: " + String(data.orig_bytes) + " sent, " + String(data.resp_bytes) + " received");
  
  return data;
}

ThreatAnalysis analyzeTraffic(NetworkData data) {
  ThreatAnalysis result;
  result.is_malicious = false;
  result.confidence = 0.0;
  result.threat_level = "MINIMAL";
  result.recommendation = "ALLOW_NORMAL_OPERATION";
  result.error = "";
  
  HTTPClient http;
  http.begin(String(api_server) + api_endpoint);
  http.addHeader("Content-Type", "application/json");
  http.setTimeout(api_timeout);
  
  DynamicJsonDocument doc(1024);
  doc["id_orig_p"] = data.id_orig_p;
  doc["id_resp_p"] = data.id_resp_p;
  doc["duration"] = data.duration;
  doc["orig_bytes"] = data.orig_bytes;
  doc["resp_bytes"] = data.resp_bytes;
  doc["missed_bytes"] = data.missed_bytes;
  doc["orig_pkts"] = data.orig_pkts;
  doc["orig_ip_bytes"] = data.orig_ip_bytes;
  doc["resp_pkts"] = data.resp_pkts;
  doc["resp_ip_bytes"] = data.resp_ip_bytes;
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  Serial.println("ğŸ“¤ Sending to ML API: " + jsonString);
  
  int httpCode = http.POST(jsonString);
  
  if (httpCode == 200) {
    String response = http.getString();
    Serial.println("ğŸ“¥ API Response: " + response);
    
    DynamicJsonDocument responseDoc(1024);
    deserializeJson(responseDoc, response);
    
    result.is_malicious = responseDoc["is_malicious"];
    result.confidence = responseDoc["confidence"];
    result.threat_level = responseDoc["threat_level"].as<String>();
    result.recommendation = responseDoc["recommendation"].as<String>();
    
  } else {
    Serial.println("âŒ API request failed");
    Serial.println("ğŸ”§ HTTP Code: " + String(httpCode));
    result.error = "API_ERROR";
  }
  
  http.end();
  return result;
}

void handleThreatResult(ThreatAnalysis result) {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘      THREAT ANALYSIS RESULT            â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  if (result.error != "") {
    Serial.println("âŒ Error: " + result.error);
    Serial.println("ğŸ’¡ Check if server is running!");
    blinkLED(LED_STATUS, 5, 100);
    return;
  }
  
  Serial.println("ğŸ¯ Malicious:     " + String(result.is_malicious ? "âš ï¸  YES âš ï¸" : "âœ… NO"));
  Serial.println("ğŸ“Š Confidence:    " + String(result.confidence * 100, 1) + "%");
  Serial.println("âš ï¸  Threat Level:  " + result.threat_level);
  Serial.println("ğŸ’¡ Recommendation: " + result.recommendation);
  
  // Visual indication with LEDs
  if (result.is_malicious) {
    Serial.println("\nğŸš¨ğŸš¨ğŸš¨ THREAT DETECTED ğŸš¨ğŸš¨ğŸš¨");
    Serial.println("ğŸ’¡ LED: Red fast blinking (ALERT)");
    
    // Turn off safe LED, fast blink threat LED
    digitalWrite(LED_SAFE, LOW);
    for (int i = 0; i < 10; i++) {
      digitalWrite(LED_THREAT, HIGH);
      delay(100);
      digitalWrite(LED_THREAT, LOW);
      delay(100);
    }
    
    if (result.recommendation == "BLOCK_IMMEDIATELY") {
      Serial.println("ğŸ›¡ï¸  ACTION: BLOCKING CONNECTION IMMEDIATELY");
    } else if (result.recommendation == "INVESTIGATE_AND_MONITOR") {
      Serial.println("ğŸ” ACTION: INVESTIGATING AND MONITORING");
    }
    
  } else {
    Serial.println("\nâœ… Traffic appears SAFE");
    Serial.println("ğŸ’¡ LED: Green slow blink (SAFE)");
    
    // Turn off threat LED, slow blink safe LED
    digitalWrite(LED_THREAT, LOW);
    for (int i = 0; i < 3; i++) {
      digitalWrite(LED_SAFE, HIGH);
      delay(300);
      digitalWrite(LED_SAFE, LOW);
      delay(300);
    }
  }
  
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void monitorNetworkActivity() {
  static unsigned long lastActivity = 0;
  
  if (millis() - lastActivity > 5000) {
    if (random(0, 100) < 10) {
      Serial.println("ğŸ“¡ Background network activity detected");
      digitalWrite(LED_STATUS, HIGH);
      delay(50);
      digitalWrite(LED_STATUS, LOW);
    }
    lastActivity = millis();
  }
}

void startupSequence() {
  Serial.println("ğŸš€ Initializing system...");
  Serial.println("ğŸ’¡ Testing all LEDs...");
  
  // Test each LED
  for (int i = 0; i < 3; i++) {
    digitalWrite(LED_SAFE, HIGH);
    delay(200);
    digitalWrite(LED_SAFE, LOW);
    digitalWrite(LED_THREAT, HIGH);
    delay(200);
    digitalWrite(LED_THREAT, LOW);
    digitalWrite(LED_STATUS, HIGH);
    delay(200);
    digitalWrite(LED_STATUS, LOW);
  }
  
  Serial.println("âœ… LED test complete");
}

void blinkLED(int pin, int times, int delayMs) {
  for (int i = 0; i < times; i++) {
    digitalWrite(pin, HIGH);
    delay(delayMs);
    digitalWrite(pin, LOW);
    delay(delayMs);
  }
}